<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∞èÂÜ¨ÁìúÊô∫ËÉΩÂä©Êâã</title>
    <style>
        :root{
            --bg1:#a8e6cf;
            --bg2:#dcedc1;
            --bg3:#ffd3b6;
            --bg4:#ffaaa5;
            --bg5:#ff8b94;
            --card: rgba(255,255,255,.85);
            --cardBorder: rgba(255,255,255,.22);
            --text:#1f2937;
            --muted:#6b7280;
            --primary:#ec4899;
            --primary2:#f97316;
            --blue:#2563eb;
            --green:#16a34a;
            --red:#ef4444;
            --shadow: 0 10px 30px rgba(31,38,135,.25);
            --radius: 14px;
            --radius2: 999px;
            --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0;
            font-family:var(--sans);
            color:var(--text);
            background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 25%, var(--bg3) 50%, var(--bg4) 75%, var(--bg5) 100%);
            overflow:auto;
        }
        .app{
            min-height:100%;
            min-height:100dvh;
            max-width: 1100px;
            margin: 0 auto;
            display:flex;
            flex-direction:column;
            padding: 0 12px;
        }
        .card{
            background: var(--card);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--cardBorder);
            box-shadow: var(--shadow);
            border-radius: var(--radius);
        }
        .header{
            margin-top: 12px;
            padding: 14px 16px;
            display:flex;
            align-items:center;
            justify-content:space-between;
        }
        .brand{
            display:flex;
            align-items:center;
            gap:10px;
            font-weight: 800;
            font-size: 18px;
            letter-spacing:.2px;
        }
        .brand .emoji{font-size: 22px}
        .status{
            font-size: 12px;
            display:flex;
            align-items:center;
            gap:8px;
            color: var(--muted);
            user-select:none;
        }
        .dot{
            width:10px;height:10px;border-radius:999px;
            background: #9ca3af;
            box-shadow: 0 0 0 3px rgba(255,255,255,.6);
        }
        .dot.online{background: var(--green)}
        .accessDetails{
            margin-top: 10px;
            padding: 0;
        }
        .accessSummary{
            list-style: none;
            cursor: pointer;
            user-select: none;
            padding: 12px;
            display:flex;
            align-items:center;
            justify-content:space-between;
        }
        .accessSummary::-webkit-details-marker{display:none}
        .accessSummaryTitle{
            font-weight: 800;
            color: rgba(31,41,55,.9);
        }
        .access{
            margin-top: 0;
            padding: 12px;
            display:grid;
            grid-template-columns: 1fr;
            gap:10px;
            border-top: 1px solid rgba(255,255,255,.32);
        }
        .row{
            display:flex;
            gap:10px;
            align-items:center;
            flex-wrap:wrap;
        }
        .row label{
            font-size: 12px;
            color: var(--muted);
            width: 70px;
            flex: 0 0 auto;
        }
        .input, .select{
            height: 36px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,.35);
            background: rgba(255,255,255,.75);
            padding: 0 12px;
            outline: none;
            min-width: 240px;
            flex: 1 1 320px;
        }
        .input:focus, .select:focus{border-color: rgba(236,72,153,.8)}
        .btn{
            height: 36px;
            padding: 0 14px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,.35);
            background: rgba(255,255,255,.75);
            color: var(--text);
            cursor:pointer;
            user-select:none;
            transition: transform .08s ease, background .2s ease, border-color .2s ease;
            white-space:nowrap;
        }
        .btn:active{transform: scale(.98)}
        .btn.primary{
            border-color: rgba(236,72,153,.55);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary2) 100%);
            color:white;
        }
        .btn.ghost{
            background: rgba(255,255,255,.55);
        }
        .btn:disabled{
            opacity: .55;
            cursor:not-allowed;
        }
        .qrRow{
            display:flex;
            align-items:center;
            gap:12px;
        }
        #qrCanvas{
            width: 120px;
            height: 120px;
            border-radius: 12px;
            background: rgba(255,255,255,.85);
            border: 1px solid rgba(255,255,255,.35);
        }
        .qrText{
            display:flex;
            flex-direction:column;
            gap:4px;
            min-width: 180px;
        }
        .qrText .title{font-weight:700}
        .qrText .sub{font-size:12px;color:var(--muted);word-break:break-all}
        .tabs{
            margin-top: 10px;
            display:flex;
            gap:8px;
            flex-wrap:wrap;
        }
        .tab{
            border: 1px solid rgba(255,255,255,.35);
            background: rgba(255,255,255,.65);
            height: 36px;
            padding: 0 14px;
            border-radius: 999px;
            cursor:pointer;
            font-weight: 700;
            color: rgba(31,41,55,.85);
        }
        .tab.active{
            background: rgba(255,255,255,.92);
            border-color: rgba(236,72,153,.45);
            color: rgba(236,72,153,.95);
        }
        .main{
            margin-top: 10px;
            margin-bottom: 12px;
            flex:1 1 auto;
            overflow:hidden;
            display:flex;
            flex-direction:column;
        }
        .panel{
            display:none;
            flex:1 1 auto;
            overflow:hidden;
        }
        .panel.active{display:flex;flex-direction:column}
        .panelHeader{
            padding: 10px 12px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            border-bottom: 1px solid rgba(255,255,255,.32);
            background: rgba(255,255,255,.5);
            border-top-left-radius: var(--radius);
            border-top-right-radius: var(--radius);
        }
        .panelTitle{
            display:flex;
            align-items:center;
            gap:10px;
            font-weight: 800;
        }
        .pill{
            font-size: 12px;
            color: var(--muted);
            background: rgba(255,255,255,.55);
            border: 1px solid rgba(255,255,255,.35);
            padding: 5px 10px;
            border-radius: 999px;
        }
        .chatList{
            padding: 12px;
            overflow:auto;
            flex: 1 1 auto;
        }
        .msg{
            display:flex;
            margin: 10px 0;
        }
        .msg.user{justify-content:flex-end}
        .bubble{
            max-width: 820px;
            width: fit-content;
            padding: 10px 12px;
            border-radius: 14px;
            white-space: pre-wrap;
            word-break: break-word;
            box-shadow: 0 6px 20px rgba(31,38,135,.12);
            font-size: 14px;
            line-height: 1.35;
        }
        .bubble.user{
            background: linear-gradient(135deg, rgba(255,154,158,.95) 0%, rgba(250,208,196,.95) 100%);
            color: #1f2937;
        }
        .bubble.agent{
            background: linear-gradient(135deg, rgba(161,196,253,.95) 0%, rgba(194,233,251,.95) 100%);
            color: #1f2937;
        }
        .bubble.system{
            background: rgba(255,255,255,.6);
            color: #4b5563;
            font-size: 12px;
            font-style: italic;
        }
        .chatInput{
            display:flex;
            gap:10px;
            padding: 12px;
            border-top: 1px solid rgba(255,255,255,.32);
            background: rgba(255,255,255,.5);
            border-bottom-left-radius: var(--radius);
            border-bottom-right-radius: var(--radius);
        }
        .chatInput .input{
            flex: 1 1 auto;
            min-width: 0;
            border-radius: var(--radius2);
            height: 42px;
        }
        .chatInput .btn{height: 42px;border-radius: var(--radius2)}
        .logs{
            flex: 1 1 auto;
            overflow:auto;
            margin: 0;
            padding: 12px;
            background: rgba(17,24,39,.85);
            color: rgba(34,197,94,.95);
            font-family: var(--mono);
            font-size: 12px;
            border-bottom-left-radius: var(--radius);
            border-bottom-right-radius: var(--radius);
        }
        .cfg{
            flex:1 1 auto;
            overflow:auto;
            padding: 12px;
        }
        .cfgRow{
            display:flex;
            gap:10px;
            align-items:center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,.26);
            flex-wrap:wrap;
        }
        .cfgKey{
            width: 260px;
            font-weight: 700;
            color: rgba(31,41,55,.85);
            overflow:hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .cfgRow .input{
            flex: 1 1 360px;
            min-width: 260px;
        }
        .cfgFooter{
            padding: 12px;
            border-top: 1px solid rgba(255,255,255,.32);
            background: rgba(255,255,255,.5);
            border-bottom-left-radius: var(--radius);
            border-bottom-right-radius: var(--radius);
            display:flex;
            gap:10px;
            align-items:center;
            flex-wrap:wrap;
        }
        .cfgFooter .input{flex: 1 1 240px; min-width: 220px;}
        @media (max-width: 640px){
            .brand{font-size: 16px}
            .header{flex-wrap:wrap; gap:10px}
            .status{width:100%; justify-content:flex-start}
            .row{gap:8px}
            .row label{width: 100%}
            .input, .select{
                min-width: 0;
                flex: 1 1 100%;
                font-size: 16px;
            }
            .btn{height: 40px}
            .row .btn{flex: 1 1 110px}
            .qrRow{flex-wrap:wrap}
            #qrCanvas{width: 108px;height: 108px}
            .qrText{min-width: 0}
            .tabs{gap:6px}
            .tab{flex: 1 1 30%; text-align:center}
            .panelHeader{flex-wrap:wrap; gap:10px}
            .panelTitle{flex-wrap:wrap}
            .bubble{max-width: 92vw}
            .cfgKey{width: 100%}
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="card header">
            <div class="brand"><span class="emoji">üçâ</span><span>Â∞èÂÜ¨ÁìúÊô∫ËÉΩÂä©Êâã</span></div>
            <div class="status"><span id="statusDot" class="dot"></span><span id="statusText">Á¶ªÁ∫ø</span></div>
        </header>

        <details id="accessDetails" class="card accessDetails" open>
            <summary class="accessSummary">
                <span class="accessSummaryTitle">ËÆøÈóÆ‰∏é‰∫åÁª¥Á†Å</span>
                <span id="accessSummaryHint" class="pill">Êî∂Ëµ∑</span>
            </summary>
            <div class="access">
                <div class="row">
                    <label>ËÆøÈóÆÂú∞ÂùÄ</label>
                    <input id="accessUrlInput" class="input" type="text" spellcheck="false" autocomplete="off" />
                    <button id="copyUrlBtn" class="btn ghost" type="button">Â§çÂà∂</button>
                    <button id="saveUrlBtn" class="btn ghost" type="button">‰øùÂ≠ò</button>
                </div>
                <div class="row">
                    <label>Â±ÄÂüüÁΩë</label>
                    <select id="lanSelect" class="select"></select>
                    <button id="useLanBtn" class="btn ghost" type="button">Â°´ÂÖ•</button>
                    <button id="refreshLanBtn" class="btn ghost" type="button">Âà∑Êñ∞</button>
                </div>
                <div class="row qrRow">
                    <canvas id="qrCanvas" width="120" height="120"></canvas>
                    <div class="qrText">
                        <div class="title">ÊâãÊú∫Êâ´Á†ÅËÆøÈóÆ</div>
                        <div id="qrStatus" class="sub"></div>
                    </div>
                </div>
            </div>
        </details>

        <nav class="tabs">
            <button class="tab active" data-tab="chat" type="button">ÂØπËØù‰∫§‰∫í</button>
            <button class="tab" data-tab="logs" type="button">ËøêË°åÊó•Âøó</button>
            <button class="tab" data-tab="config" type="button">ÈÖçÁΩÆÁÆ°ÁêÜ</button>
        </nav>

        <main class="main">
            <section id="panel-chat" class="card panel active">
                <div class="panelHeader">
                    <div class="panelTitle">
                        <span>Ê®°Âûã</span>
                        <select id="modelSelect" class="select" style="min-width:160px;flex:0 0 auto;"></select>
                        <span id="modelInfo" class="pill"></span>
                    </div>
                    <span id="chatConn" class="pill">Êú™ËøûÊé•</span>
                </div>
                <div id="chatList" class="chatList"></div>
                <div class="chatInput">
                    <input id="chatInput" class="input" type="text" placeholder="ËæìÂÖ•Êåá‰ª§..." autocomplete="off" />
                    <button id="sendBtn" class="btn primary" type="button">ÂèëÈÄÅ</button>
                </div>
            </section>

            <section id="panel-logs" class="card panel">
                <div class="panelHeader">
                    <div class="panelTitle">ÂÆûÊó∂ËæìÂá∫</div>
                    <button id="clearLogsBtn" class="btn ghost" type="button">Ê∏ÖÁ©∫</button>
                </div>
                <pre id="logsPre" class="logs"></pre>
            </section>

            <section id="panel-config" class="card panel">
                <div class="panelHeader">
                    <div class="panelTitle">ÁéØÂ¢ÉÂèòÈáè</div>
                    <button id="reloadConfigBtn" class="btn ghost" type="button">Âà∑Êñ∞</button>
                </div>
                <div id="configBody" class="cfg"></div>
                <div class="cfgFooter">
                    <input id="newKey" class="input" type="text" placeholder="ÈîÆ (Â¶Ç API_KEY)" autocomplete="off" />
                    <input id="newValue" class="input" type="text" placeholder="ÂÄº" autocomplete="off" />
                    <button id="addConfigBtn" class="btn primary" type="button">Ê∑ªÂä†</button>
                </div>
            </section>
        </main>
    </div>

    <script>
        (function(){
            function el(id){return document.getElementById(id)}

            var state = {
                currentTab: 'chat',
                chatConnected: false,
                logConnected: false,
                chatWs: null,
                logWs: null,
                modelChanging: false,
                modelCurrent: 'deepseek',
                modelOptions: []
            }

            function setOnline(online){
                var dot = el('statusDot')
                var text = el('statusText')
                if (online){
                    dot.classList.add('online')
                    text.textContent = 'Âú®Á∫ø'
                }else{
                    dot.classList.remove('online')
                    text.textContent = 'Á¶ªÁ∫ø'
                }
            }

            function setChatConn(connected){
                state.chatConnected = connected
                el('chatConn').textContent = connected ? 'Â∑≤ËøûÊé•' : 'Êú™ËøûÊé•'
                el('sendBtn').disabled = !connected
                el('chatInput').disabled = !connected
            }

            function setModelInfo(text){
                el('modelInfo').textContent = text || ''
            }

            function appendChatMessage(raw){
                var msg = (raw == null ? '' : String(raw))
                var type = 'system'
                if (msg.startsWith('User:') || msg.startsWith('User :')) type = 'user'
                else if (msg.startsWith('Agent:')) type = 'agent'
                else if (msg.startsWith('>>>')) type = 'system'

                var wrap = document.createElement('div')
                wrap.className = 'msg' + (type === 'user' ? ' user' : '')
                var bubble = document.createElement('div')
                bubble.className = 'bubble ' + type
                bubble.textContent = msg
                wrap.appendChild(bubble)
                el('chatList').appendChild(wrap)
                el('chatList').scrollTop = el('chatList').scrollHeight
            }

            function setLogsText(line){
                var pre = el('logsPre')
                pre.textContent += line
                if (!line.endsWith('\n')) pre.textContent += '\n'
                pre.scrollTop = pre.scrollHeight
            }

            function switchTab(next){
                state.currentTab = next
                Array.prototype.forEach.call(document.querySelectorAll('.tab'), function(btn){
                    btn.classList.toggle('active', btn.dataset.tab === next)
                })
                Array.prototype.forEach.call(document.querySelectorAll('.panel'), function(panel){
                    panel.classList.toggle('active', panel.id === ('panel-' + next))
                })
            }

            function wsUrl(path){
                var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:'
                return protocol + '//' + window.location.host + path
            }

            function connectChatWS(){
                try{ if (state.chatWs) state.chatWs.close() }catch(e){}
                var ws = new WebSocket(wsUrl('/api/chat/ws'))
                state.chatWs = ws

                ws.onopen = function(){
                    setChatConn(true)
                    appendChatMessage('>>> Á≥ªÁªü: Â∑≤ËøûÊé•Âà∞Â∞èÂÜ¨Áìú')
                }
                ws.onmessage = function(ev){
                    appendChatMessage(ev.data)
                }
                ws.onclose = function(){
                    setChatConn(false)
                    appendChatMessage('>>> Á≥ªÁªü: ËøûÊé•Êñ≠ÂºÄÔºå3ÁßíÂêéÈáçËøû...')
                    setTimeout(connectChatWS, 3000)
                }
                ws.onerror = function(){
                    setChatConn(false)
                }
            }

            function connectLogWS(){
                try{ if (state.logWs) state.logWs.close() }catch(e){}
                var ws = new WebSocket(wsUrl('/api/logs/ws'))
                state.logWs = ws

                ws.onopen = function(){
                    state.logConnected = true
                    setOnline(true)
                    setLogsText('>>> Â∑≤ËøûÊé•Âà∞Êó•ÂøóÊµÅ')
                }
                ws.onmessage = function(ev){
                    setLogsText(ev.data)
                }
                ws.onclose = function(){
                    state.logConnected = false
                    setOnline(false)
                    setLogsText('>>> Â∑≤Êñ≠ÂºÄËøûÊé•Ôºå3ÁßíÂêéÈáçËøû...')
                    setTimeout(connectLogWS, 3000)
                }
                ws.onerror = function(){
                    state.logConnected = false
                    setOnline(false)
                }
            }

            function sendMessage(){
                var input = el('chatInput')
                var msg = (input.value || '').trim()
                if (!msg || !state.chatConnected) return
                input.value = ''
                appendChatMessage('User: ' + msg)
                fetch('/api/chat/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                }).then(function(res){
                    if (!res.ok) appendChatMessage('>>> Á≥ªÁªü: ÂèëÈÄÅÂ§±Ë¥•')
                }).catch(function(e){
                    appendChatMessage('>>> Á≥ªÁªü: ÂèëÈÄÅÂá∫Èîô ' + e)
                })
            }

            function loadModels(){
                fetch('/api/chat/models').then(function(r){return r.json()}).then(function(data){
                    state.modelOptions = data.models || []
                    state.modelCurrent = data.current || 'deepseek'
                    var sel = el('modelSelect')
                    sel.innerHTML = ''
                    state.modelOptions.forEach(function(m){
                        var opt = document.createElement('option')
                        opt.value = m.id
                        opt.textContent = m.label
                        sel.appendChild(opt)
                    })
                    sel.value = state.modelCurrent
                    setModelInfo('ÂΩìÂâç: ' + (sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].textContent : sel.value))
                }).catch(function(e){
                    appendChatMessage('>>> Á≥ªÁªü: Âä†ËΩΩÊ®°ÂûãÂàóË°®Â§±Ë¥• ' + e)
                })
            }

            function changeModel(){
                var sel = el('modelSelect')
                var provider = sel.value
                if (!provider) return
                setModelInfo('ÂàáÊç¢‰∏≠...')
                fetch('/api/chat/model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider: provider })
                }).then(function(res){
                    if (res.ok){
                        appendChatMessage('>>> Á≥ªÁªü: Â∑≤ËØ∑Ê±ÇÂàáÊç¢Ê®°Âûã‰∏∫ ' + provider)
                        setModelInfo('ÂΩìÂâç: ' + (sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].textContent : provider))
                    }else{
                        appendChatMessage('>>> Á≥ªÁªü: ÂàáÊç¢Ê®°ÂûãÂ§±Ë¥• (' + res.status + ')')
                        setModelInfo('ÂàáÊç¢Â§±Ë¥•')
                    }
                }).catch(function(e){
                    appendChatMessage('>>> Á≥ªÁªü: ÂàáÊç¢Ê®°ÂûãÂá∫Èîô ' + e)
                    setModelInfo('ÂàáÊç¢Â§±Ë¥•')
                })
            }

            function loadConfig(){
                var body = el('configBody')
                body.textContent = ''
                fetch('/api/config').then(function(r){return r.json()}).then(function(data){
                    var keys = Object.keys(data || {}).sort()
                    if (!keys.length){
                        var empty = document.createElement('div')
                        empty.className = 'pill'
                        empty.textContent = 'ÊöÇÊó†ÈÖçÁΩÆ'
                        body.appendChild(empty)
                        return
                    }
                    keys.forEach(function(key){
                        var row = document.createElement('div')
                        row.className = 'cfgRow'
                        var label = document.createElement('div')
                        label.className = 'cfgKey'
                        label.title = key
                        label.textContent = key
                        var input = document.createElement('input')
                        input.className = 'input'
                        input.type = 'text'
                        input.value = data[key] == null ? '' : String(data[key])
                        input.autocomplete = 'off'
                        var btn = document.createElement('button')
                        btn.className = 'btn ghost'
                        btn.type = 'button'
                        btn.textContent = '‰øùÂ≠ò'
                        btn.disabled = true
                        var original = input.value
                        input.addEventListener('input', function(){
                            btn.disabled = input.value === original
                        })
                        btn.addEventListener('click', function(){
                            btn.disabled = true
                            fetch('/api/config', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ key: key, value: input.value })
                            }).then(function(res){
                                if (res.ok){
                                    original = input.value
                                    btn.disabled = true
                                }else{
                                    btn.disabled = false
                                    appendChatMessage('>>> Á≥ªÁªü: Êõ¥Êñ∞ÈÖçÁΩÆÂ§±Ë¥• (' + res.status + ')')
                                }
                            }).catch(function(e){
                                btn.disabled = false
                                appendChatMessage('>>> Á≥ªÁªü: Êõ¥Êñ∞ÈÖçÁΩÆÂá∫Èîô ' + e)
                            })
                        })
                        row.appendChild(label)
                        row.appendChild(input)
                        row.appendChild(btn)
                        body.appendChild(row)
                    })
                }).catch(function(e){
                    appendChatMessage('>>> Á≥ªÁªü: Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥• ' + e)
                })
            }

            function addConfig(){
                var k = (el('newKey').value || '').trim()
                var v = (el('newValue').value || '').trim()
                if (!k) return
                fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key: k, value: v })
                }).then(function(res){
                    if (res.ok){
                        el('newKey').value = ''
                        el('newValue').value = ''
                        loadConfig()
                    }else{
                        appendChatMessage('>>> Á≥ªÁªü: Ê∑ªÂä†ÈÖçÁΩÆÂ§±Ë¥• (' + res.status + ')')
                    }
                }).catch(function(e){
                    appendChatMessage('>>> Á≥ªÁªü: Ê∑ªÂä†ÈÖçÁΩÆÂá∫Èîô ' + e)
                })
            }

            function setAccessUrl(url){
                var u = (url || '').trim()
                el('accessUrlInput').value = u
                localStorage.setItem('accessUrl', u)
                renderQr(u)
                el('qrStatus').textContent = u ? u : ''
            }

            function copyAccessUrl(){
                var text = (el('accessUrlInput').value || '').trim()
                if (!text) return
                if (navigator.clipboard && navigator.clipboard.writeText){
                    navigator.clipboard.writeText(text).then(function(){
                        appendChatMessage('>>> Á≥ªÁªü: Â∑≤Â§çÂà∂ËÆøÈóÆÂú∞ÂùÄ')
                    }).catch(function(){
                        prompt('Â§çÂà∂ËÆøÈóÆÂú∞ÂùÄ', text)
                    })
                }else{
                    prompt('Â§çÂà∂ËÆøÈóÆÂú∞ÂùÄ', text)
                }
            }

            function loadSavedAccessUrl(){
                return fetch('/api/config/access-url').then(function(r){ return r.json() }).then(function(data){
                    var u = (data && data.url) ? String(data.url).trim() : ''
                    if (u) setAccessUrl(u)
                }).catch(function(){})
            }

            function saveAccessUrl(){
                var u = (el('accessUrlInput').value || '').trim()
                fetch('/api/config/access-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: u })
                }).then(function(res){
                    if (res.ok){
                        appendChatMessage('>>> Á≥ªÁªü: Â∑≤‰øùÂ≠òËÆøÈóÆÂú∞ÂùÄ')
                    }else{
                        appendChatMessage('>>> Á≥ªÁªü: ‰øùÂ≠òËÆøÈóÆÂú∞ÂùÄÂ§±Ë¥• (' + res.status + ')')
                    }
                }).catch(function(e){
                    appendChatMessage('>>> Á≥ªÁªü: ‰øùÂ≠òËÆøÈóÆÂú∞ÂùÄÂá∫Èîô ' + e)
                })
            }

            function loadLanHosts(){
                var sel = el('lanSelect')
                sel.innerHTML = ''
                fetch('/api/config/hosts').then(function(r){return r.json()}).then(function(data){
                    var urls = (data && data.urls) ? data.urls : []
                    if (!urls.length){
                        var opt = document.createElement('option')
                        opt.value = ''
                        opt.textContent = 'Êú™Ê£ÄÊµãÂà∞Â±ÄÂüüÁΩëÂú∞ÂùÄ'
                        sel.appendChild(opt)
                        return
                    }
                    urls.forEach(function(u){
                        var opt = document.createElement('option')
                        opt.value = u
                        opt.textContent = u
                        sel.appendChild(opt)
                    })
                    var current = (el('accessUrlInput').value || '').trim()
                    if ((!current || current.indexOf('localhost') >= 0 || current.indexOf('127.0.0.1') >= 0) && urls[0]){
                        setAccessUrl(urls[0])
                    }
                }).catch(function(e){
                    appendChatMessage('>>> Á≥ªÁªü: Ëé∑ÂèñÂ±ÄÂüüÁΩëÂú∞ÂùÄÂ§±Ë¥• ' + e)
                })
            }

            function useLanSelected(){
                var u = el('lanSelect').value
                if (u) setAccessUrl(u)
            }

            function updateAccessSummaryHint(){
                var d = el('accessDetails')
                var hint = el('accessSummaryHint')
                if (!d || !hint) return
                hint.textContent = d.open ? 'Êî∂Ëµ∑' : 'Â±ïÂºÄ'
            }

            function initAccessPanel(){
                var d = el('accessDetails')
                if (!d) return
                var saved = localStorage.getItem('accessPanelOpen')
                if (saved === '0' || saved === '1'){
                    d.open = saved === '1'
                }else if (window.matchMedia && window.matchMedia('(max-width: 640px)').matches){
                    d.open = false
                }
                updateAccessSummaryHint()
                d.addEventListener('toggle', function(){
                    localStorage.setItem('accessPanelOpen', d.open ? '1' : '0')
                    updateAccessSummaryHint()
                })
            }

            function initAccessUrl(){
                var stored = localStorage.getItem('accessUrl')
                var fallback = window.location.origin + '/'
                setAccessUrl(stored || fallback)
                loadSavedAccessUrl().then(function(){ loadLanHosts() }).catch(function(){ loadLanHosts() })
            }

            function renderQr(text){
                var canvas = el('qrCanvas')
                var ctx = canvas.getContext('2d')
                ctx.clearRect(0,0,canvas.width,canvas.height)
                var value = (text || '').trim()
                if (!value) return
                try{
                    var qr = qrcode(0, 'M')
                    qr.addData(value)
                    qr.make()
                    var count = qr.getModuleCount()
                    var margin = 2
                    var size = canvas.width
                    var cell = Math.floor((size - margin*2) / count)
                    var offset = Math.floor((size - cell*count) / 2)
                    ctx.fillStyle = '#ffffff'
                    ctx.fillRect(0,0,size,size)
                    for (var r=0;r<count;r++){
                        for (var c=0;c<count;c++){
                            ctx.fillStyle = qr.isDark(r,c) ? '#111827' : '#ffffff'
                            ctx.fillRect(offset + c*cell, offset + r*cell, cell, cell)
                        }
                    }
                }catch(e){
                    ctx.fillStyle = '#ffffff'
                    ctx.fillRect(0,0,canvas.width,canvas.height)
                }
            }

            function qrcode(typeNumber, errorCorrectionLevel){
                var PAD0 = 0xEC
                var PAD1 = 0x11
                var _typeNumber = typeNumber
                var _errorCorrectionLevel = QRErrorCorrectionLevel[errorCorrectionLevel]
                var _modules = null
                var _moduleCount = 0
                var _dataCache = null
                var _dataList = []

                var _this = {}
                _this.addData = function(data){
                    var newData = qr8BitByte(data)
                    _dataList.push(newData)
                    _dataCache = null
                }
                _this.isDark = function(row,col){
                    if (_modules[row][col] != null) return _modules[row][col]
                    return false
                }
                _this.getModuleCount = function(){ return _moduleCount }
                _this.make = function(){
                    if (_typeNumber < 1){
                        var typeNumber = 1
                        for (typeNumber = 1; typeNumber < 40; typeNumber++){
                            var rsBlocks = QRRSBlock.getRSBlocks(typeNumber, _errorCorrectionLevel)
                            var buffer = qrBitBuffer()
                            var totalDataCount = 0
                            for (var i=0;i<rsBlocks.length;i++) totalDataCount += rsBlocks[i].dataCount
                            for (var i2=0;i2<_dataList.length;i2++){
                                var data = _dataList[i2]
                                buffer.put(data.mode, 4)
                                buffer.put(data.getLength(), QRUtil.getLengthInBits(data.mode, typeNumber))
                                data.write(buffer)
                            }
                            if (buffer.getLengthInBits() <= totalDataCount * 8) break
                        }
                        _typeNumber = typeNumber
                    }
                    makeImpl(false, getBestMaskPattern())
                }

                function makeImpl(test, maskPattern){
                    _moduleCount = _typeNumber * 4 + 17
                    _modules = new Array(_moduleCount)
                    for (var row=0; row<_moduleCount; row++){
                        _modules[row] = new Array(_moduleCount)
                        for (var col=0; col<_moduleCount; col++) _modules[row][col] = null
                    }
                    setupPositionProbePattern(0,0)
                    setupPositionProbePattern(_moduleCount - 7, 0)
                    setupPositionProbePattern(0, _moduleCount - 7)
                    setupPositionAdjustPattern()
                    setupTimingPattern()
                    setupTypeInfo(test, maskPattern)
                    if (_typeNumber >= 7) setupTypeNumber(test)
                    if (_dataCache == null) _dataCache = createData(_typeNumber, _errorCorrectionLevel, _dataList)
                    mapData(_dataCache, maskPattern)
                }

                function setupPositionProbePattern(row, col){
                    for (var r=-1; r<=7; r++){
                        if (row + r <= -1 || _moduleCount <= row + r) continue
                        for (var c=-1; c<=7; c++){
                            if (col + c <= -1 || _moduleCount <= col + c) continue
                            if ((0 <= r && r <= 6 && (c == 0 || c == 6)) || (0 <= c && c <= 6 && (r == 0 || r == 6)) || (2 <= r && r <= 4 && 2 <= c && c <= 4)){
                                _modules[row + r][col + c] = true
                            } else {
                                _modules[row + r][col + c] = false
                            }
                        }
                    }
                }

                function getBestMaskPattern(){
                    var minLostPoint = 0
                    var pattern = 0
                    for (var i=0; i<8; i++){
                        makeImpl(true, i)
                        var lostPoint = QRUtil.getLostPoint(_this)
                        if (i == 0 || minLostPoint > lostPoint){
                            minLostPoint = lostPoint
                            pattern = i
                        }
                    }
                    return pattern
                }

                function setupTimingPattern(){
                    for (var i=8; i<_moduleCount - 8; i++){
                        if (_modules[i][6] != null) continue
                        _modules[i][6] = (i % 2 == 0)
                    }
                    for (var j=8; j<_moduleCount - 8; j++){
                        if (_modules[6][j] != null) continue
                        _modules[6][j] = (j % 2 == 0)
                    }
                }

                function setupPositionAdjustPattern(){
                    var pos = QRUtil.getPatternPosition(_typeNumber)
                    for (var i=0; i<pos.length; i++){
                        for (var j=0; j<pos.length; j++){
                            var row = pos[i]
                            var col = pos[j]
                            if (_modules[row][col] != null) continue
                            for (var r=-2; r<=2; r++){
                                for (var c=-2; c<=2; c++){
                                    if (r == -2 || r == 2 || c == -2 || c == 2 || (r == 0 && c == 0)){
                                        _modules[row + r][col + c] = true
                                    } else {
                                        _modules[row + r][col + c] = false
                                    }
                                }
                            }
                        }
                    }
                }

                function setupTypeNumber(test){
                    var bits = QRUtil.getBCHTypeNumber(_typeNumber)
                    for (var i=0; i<18; i++){
                        var mod = (!test && ((bits >> i) & 1) == 1)
                        _modules[Math.floor(i / 3)][i % 3 + _moduleCount - 8 - 3] = mod
                    }
                    for (var j=0; j<18; j++){
                        var mod2 = (!test && ((bits >> j) & 1) == 1)
                        _modules[j % 3 + _moduleCount - 8 - 3][Math.floor(j / 3)] = mod2
                    }
                }

                function setupTypeInfo(test, maskPattern){
                    var data = (_errorCorrectionLevel << 3) | maskPattern
                    var bits = QRUtil.getBCHTypeInfo(data)
                    for (var i=0; i<15; i++){
                        var mod = (!test && ((bits >> i) & 1) == 1)
                        if (i < 6){
                            _modules[i][8] = mod
                        } else if (i < 8){
                            _modules[i + 1][8] = mod
                        } else {
                            _modules[_moduleCount - 15 + i][8] = mod
                        }
                    }
                    for (var j=0; j<15; j++){
                        var mod2 = (!test && ((bits >> j) & 1) == 1)
                        if (j < 8){
                            _modules[8][_moduleCount - j - 1] = mod2
                        } else if (j < 9){
                            _modules[8][15 - j - 1 + 1] = mod2
                        } else {
                            _modules[8][15 - j - 1] = mod2
                        }
                    }
                    _modules[_moduleCount - 8][8] = (!test)
                }

                function mapData(data, maskPattern){
                    var inc = -1
                    var row = _moduleCount - 1
                    var bitIndex = 7
                    var byteIndex = 0
                    for (var col=_moduleCount - 1; col>0; col-=2){
                        if (col == 6) col--
                        while (true){
                            for (var c=0; c<2; c++){
                                if (_modules[row][col - c] == null){
                                    var dark = false
                                    if (byteIndex < data.length){
                                        dark = (((data[byteIndex] >>> bitIndex) & 1) == 1)
                                    }
                                    var mask = QRUtil.getMask(maskPattern, row, col - c)
                                    if (mask) dark = !dark
                                    _modules[row][col - c] = dark
                                    bitIndex--
                                    if (bitIndex == -1){
                                        byteIndex++
                                        bitIndex = 7
                                    }
                                }
                            }
                            row += inc
                            if (row < 0 || _moduleCount <= row){
                                row -= inc
                                inc = -inc
                                break
                            }
                        }
                    }
                }

                function createData(typeNumber, errorCorrectionLevel, dataList){
                    var rsBlocks = QRRSBlock.getRSBlocks(typeNumber, errorCorrectionLevel)
                    var buffer = qrBitBuffer()
                    for (var i=0; i<dataList.length; i++){
                        var data = dataList[i]
                        buffer.put(data.mode, 4)
                        buffer.put(data.getLength(), QRUtil.getLengthInBits(data.mode, typeNumber))
                        data.write(buffer)
                    }
                    var totalDataCount = 0
                    for (var i2=0; i2<rsBlocks.length; i2++) totalDataCount += rsBlocks[i2].dataCount
                    if (buffer.getLengthInBits() > totalDataCount * 8) throw new Error('code length overflow. (' + buffer.getLengthInBits() + '>' + totalDataCount * 8 + ')')
                    if (buffer.getLengthInBits() + 4 <= totalDataCount * 8) buffer.put(0, 4)
                    while (buffer.getLengthInBits() % 8 != 0) buffer.putBit(false)
                    while (true){
                        if (buffer.getLengthInBits() >= totalDataCount * 8) break
                        buffer.put(PAD0, 8)
                        if (buffer.getLengthInBits() >= totalDataCount * 8) break
                        buffer.put(PAD1, 8)
                    }
                    return createBytes(buffer, rsBlocks)
                }

                function createBytes(buffer, rsBlocks){
                    var offset = 0
                    var maxDcCount = 0
                    var maxEcCount = 0
                    var dcdata = new Array(rsBlocks.length)
                    var ecdata = new Array(rsBlocks.length)
                    for (var r=0; r<rsBlocks.length; r++){
                        var dcCount = rsBlocks[r].dataCount
                        var ecCount = rsBlocks[r].totalCount - dcCount
                        maxDcCount = Math.max(maxDcCount, dcCount)
                        maxEcCount = Math.max(maxEcCount, ecCount)
                        dcdata[r] = new Array(dcCount)
                        for (var i=0; i<dcdata[r].length; i++) dcdata[r][i] = 0xff & buffer.getBuffer()[i + offset]
                        offset += dcCount
                        var rsPoly = QRUtil.getErrorCorrectPolynomial(ecCount)
                        var rawPoly = qrPolynomial(dcdata[r], rsPoly.getLength() - 1)
                        var modPoly = rawPoly.mod(rsPoly)
                        ecdata[r] = new Array(rsPoly.getLength() - 1)
                        for (var i2=0; i2<ecdata[r].length; i2++){
                            var modIndex = i2 + modPoly.getLength() - ecdata[r].length
                            ecdata[r][i2] = (modIndex >= 0) ? modPoly.getAt(modIndex) : 0
                        }
                    }
                    var totalCodeCount = 0
                    for (var i3=0; i3<rsBlocks.length; i3++) totalCodeCount += rsBlocks[i3].totalCount
                    var data = new Array(totalCodeCount)
                    var index = 0
                    for (var i4=0; i4<maxDcCount; i4++){
                        for (var r2=0; r2<rsBlocks.length; r2++){
                            if (i4 < dcdata[r2].length) data[index++] = dcdata[r2][i4]
                        }
                    }
                    for (var i5=0; i5<maxEcCount; i5++){
                        for (var r3=0; r3<rsBlocks.length; r3++){
                            if (i5 < ecdata[r3].length) data[index++] = ecdata[r3][i5]
                        }
                    }
                    return data
                }

                return _this
            }

            var QRMode = { MODE_8BIT_BYTE: 1 << 2 }
            var QRErrorCorrectionLevel = { L: 1, M: 0, Q: 3, H: 2 }

            function qr8BitByte(data){
                var _data = data
                var _this = {}
                _this.mode = QRMode.MODE_8BIT_BYTE
                _this.getLength = function(){
                    return new TextEncoder().encode(_data).length
                }
                _this.write = function(buffer){
                    var bytes = new TextEncoder().encode(_data)
                    for (var i=0; i<bytes.length; i++) buffer.put(bytes[i], 8)
                }
                return _this
            }

            function qrBitBuffer(){
                var _buffer = []
                var _length = 0
                var _this = {}
                _this.getBuffer = function(){ return _buffer }
                _this.getLengthInBits = function(){ return _length }
                _this.put = function(num, length){
                    for (var i=0; i<length; i++) _this.putBit(((num >>> (length - i - 1)) & 1) == 1)
                }
                _this.putBit = function(bit){
                    var bufIndex = Math.floor(_length / 8)
                    if (_buffer.length <= bufIndex) _buffer.push(0)
                    if (bit) _buffer[bufIndex] |= (0x80 >>> (_length % 8))
                    _length++
                }
                return _this
            }

            function qrPolynomial(num, shift){
                var _num = num
                var _this = {}
                if (typeof num.length == 'undefined') throw new Error(num.length + '/' + shift)
                var offset = 0
                while (offset < _num.length && _num[offset] == 0) offset++
                _num = _num.slice(offset)
                var _poly = new Array(_num.length + shift)
                for (var i=0; i<_num.length; i++) _poly[i] = _num[i]
                for (var i2=_num.length; i2<_poly.length; i2++) _poly[i2] = 0
                _this.getAt = function(index){ return _poly[index] }
                _this.getLength = function(){ return _poly.length }
                _this.multiply = function(e){
                    var num2 = new Array(_this.getLength() + e.getLength() - 1)
                    for (var i=0; i<num2.length; i++) num2[i] = 0
                    for (var i2=0; i2<_this.getLength(); i2++){
                        for (var j=0; j<e.getLength(); j++){
                            num2[i2 + j] ^= QRMath.gexp(QRMath.glog(_this.getAt(i2)) + QRMath.glog(e.getAt(j)))
                        }
                    }
                    return qrPolynomial(num2, 0)
                }
                _this.mod = function(e){
                    if (_this.getLength() - e.getLength() < 0) return _this
                    var ratio = QRMath.glog(_this.getAt(0)) - QRMath.glog(e.getAt(0))
                    var num3 = new Array(_this.getLength())
                    for (var i=0; i<_this.getLength(); i++) num3[i] = _this.getAt(i)
                    for (var i2=0; i2<e.getLength(); i2++) num3[i2] ^= QRMath.gexp(QRMath.glog(e.getAt(i2)) + ratio)
                    return qrPolynomial(num3, 0).mod(e)
                }
                return _this
            }

            var QRMath = (function(){
                var EXP_TABLE = new Array(256)
                var LOG_TABLE = new Array(256)
                for (var i=0; i<8; i++) EXP_TABLE[i] = 1 << i
                for (var i2=8; i2<256; i2++) EXP_TABLE[i2] = EXP_TABLE[i2 - 4] ^ EXP_TABLE[i2 - 5] ^ EXP_TABLE[i2 - 6] ^ EXP_TABLE[i2 - 8]
                for (var i3=0; i3<255; i3++) LOG_TABLE[EXP_TABLE[i3]] = i3
                return {
                    glog: function(n){ if (n < 1) throw new Error('glog(' + n + ')'); return LOG_TABLE[n] },
                    gexp: function(n){ while (n < 0) n += 255; while (n >= 256) n -= 255; return EXP_TABLE[n] }
                }
            })()

            var QRUtil = (function(){
                var PATTERN_POSITION_TABLE = [
                    [], [6,18], [6,22], [6,26], [6,30], [6,34], [6,22,38], [6,24,42], [6,26,46], [6,28,50],
                    [6,30,54], [6,32,58], [6,34,62], [6,26,46,66], [6,26,48,70], [6,26,50,74], [6,30,54,78],
                    [6,30,56,82], [6,30,58,86], [6,34,62,90], [6,28,50,72,94], [6,26,50,74,98], [6,30,54,78,102],
                    [6,28,54,80,106], [6,32,58,84,110], [6,30,58,86,114], [6,34,62,90,118], [6,26,50,74,98,122],
                    [6,30,54,78,102,126], [6,26,52,78,104,130], [6,30,56,82,108,134], [6,34,60,86,112,138],
                    [6,30,58,86,114,142], [6,34,62,90,118,146], [6,30,54,78,102,126,150], [6,24,50,76,102,128,154],
                    [6,28,54,80,106,132,158], [6,32,58,84,110,136,162], [6,26,54,82,110,138,166], [6,30,58,86,114,142,170]
                ]
                var G15 = (1 << 10) | (1 << 8) | (1 << 5) | (1 << 4) | (1 << 2) | (1 << 1) | (1 << 0)
                var G18 = (1 << 12) | (1 << 11) | (1 << 10) | (1 << 9) | (1 << 8) | (1 << 5) | (1 << 2) | (1 << 0)
                var G15_MASK = (1 << 14) | (1 << 12) | (1 << 10) | (1 << 4) | (1 << 1)

                function getBCHDigit(data){
                    var digit = 0
                    while (data != 0){
                        digit++
                        data >>>= 1
                    }
                    return digit
                }

                return {
                    getBCHTypeInfo: function(data){
                        var d = data << 10
                        while (getBCHDigit(d) - getBCHDigit(G15) >= 0) d ^= (G15 << (getBCHDigit(d) - getBCHDigit(G15)))
                        return ((data << 10) | d) ^ G15_MASK
                    },
                    getBCHTypeNumber: function(data){
                        var d = data << 12
                        while (getBCHDigit(d) - getBCHDigit(G18) >= 0) d ^= (G18 << (getBCHDigit(d) - getBCHDigit(G18)))
                        return (data << 12) | d
                    },
                    getPatternPosition: function(typeNumber){ return PATTERN_POSITION_TABLE[typeNumber - 1] },
                    getMask: function(maskPattern, i, j){
                        switch (maskPattern){
                            case 0: return (i + j) % 2 == 0
                            case 1: return i % 2 == 0
                            case 2: return j % 3 == 0
                            case 3: return (i + j) % 3 == 0
                            case 4: return (Math.floor(i / 2) + Math.floor(j / 3)) % 2 == 0
                            case 5: return (i * j) % 2 + (i * j) % 3 == 0
                            case 6: return ((i * j) % 2 + (i * j) % 3) % 2 == 0
                            case 7: return ((i * j) % 3 + (i + j) % 2) % 2 == 0
                            default: throw new Error('bad maskPattern:' + maskPattern)
                        }
                    },
                    getErrorCorrectPolynomial: function(errorCorrectLength){
                        var a = qrPolynomial([1], 0)
                        for (var i=0; i<errorCorrectLength; i++) a = a.multiply(qrPolynomial([1, QRMath.gexp(i)], 0))
                        return a
                    },
                    getLengthInBits: function(mode, type){
                        if (1 <= type && type < 10){
                            switch(mode){
                                case QRMode.MODE_8BIT_BYTE: return 8
                                default: throw new Error('mode:' + mode)
                            }
                        }else if (type < 27){
                            switch(mode){
                                case QRMode.MODE_8BIT_BYTE: return 16
                                default: throw new Error('mode:' + mode)
                            }
                        }else if (type < 41){
                            switch(mode){
                                case QRMode.MODE_8BIT_BYTE: return 16
                                default: throw new Error('mode:' + mode)
                            }
                        }else{
                            throw new Error('type:' + type)
                        }
                    },
                    getLostPoint: function(qr){
                        var moduleCount = qr.getModuleCount()
                        var lostPoint = 0
                        for (var row=0; row<moduleCount; row++){
                            for (var col=0; col<moduleCount; col++){
                                var sameCount = 0
                                var dark = qr.isDark(row, col)
                                for (var r=-1; r<=1; r++){
                                    if (row + r < 0 || moduleCount <= row + r) continue
                                    for (var c=-1; c<=1; c++){
                                        if (col + c < 0 || moduleCount <= col + c) continue
                                        if (r == 0 && c == 0) continue
                                        if (dark == qr.isDark(row + r, col + c)) sameCount++
                                    }
                                }
                                if (sameCount > 5) lostPoint += (3 + sameCount - 5)
                            }
                        }
                        for (var row2=0; row2<moduleCount - 1; row2++){
                            for (var col2=0; col2<moduleCount - 1; col2++){
                                var count = 0
                                if (qr.isDark(row2, col2)) count++
                                if (qr.isDark(row2 + 1, col2)) count++
                                if (qr.isDark(row2, col2 + 1)) count++
                                if (qr.isDark(row2 + 1, col2 + 1)) count++
                                if (count == 0 || count == 4) lostPoint += 3
                            }
                        }
                        for (var row3=0; row3<moduleCount; row3++){
                            for (var col3=0; col3<moduleCount - 6; col3++){
                                if (qr.isDark(row3, col3) && !qr.isDark(row3, col3 + 1) && qr.isDark(row3, col3 + 2) && qr.isDark(row3, col3 + 3) && qr.isDark(row3, col3 + 4) && !qr.isDark(row3, col3 + 5) && qr.isDark(row3, col3 + 6)){
                                    lostPoint += 40
                                }
                            }
                        }
                        for (var col4=0; col4<moduleCount; col4++){
                            for (var row4=0; row4<moduleCount - 6; row4++){
                                if (qr.isDark(row4, col4) && !qr.isDark(row4 + 1, col4) && qr.isDark(row4 + 2, col4) && qr.isDark(row4 + 3, col4) && qr.isDark(row4 + 4, col4) && !qr.isDark(row4 + 5, col4) && qr.isDark(row4 + 6, col4)){
                                    lostPoint += 40
                                }
                            }
                        }
                        var darkCount = 0
                        for (var col5=0; col5<moduleCount; col5++){
                            for (var row5=0; row5<moduleCount; row5++){
                                if (qr.isDark(row5, col5)) darkCount++
                            }
                        }
                        var ratio = Math.abs(100 * darkCount / moduleCount / moduleCount - 50) / 5
                        lostPoint += ratio * 10
                        return lostPoint
                    }
                }
            })()

            var QRRSBlock = (function(){
                function QRRSBlock(totalCount, dataCount){
                    this.totalCount = totalCount
                    this.dataCount = dataCount
                }
                var RS_BLOCK_TABLE = [
                    [1,26,19],[1,26,16],[1,26,13],[1,26,9],
                    [1,44,34],[1,44,28],[1,44,22],[1,44,16],
                    [1,70,55],[1,70,44],[2,35,17],[2,35,13],
                    [1,100,80],[2,50,32],[2,50,24],[4,25,9],
                    [1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],
                    [2,86,68],[4,43,27],[4,43,19],[4,43,15],
                    [2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],
                    [2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],
                    [2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],
                    [2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],
                    [4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],
                    [2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],
                    [4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],
                    [3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],
                    [5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12,7,37,13],
                    [5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],
                    [1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],
                    [5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],
                    [3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],
                    [3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16]
                ]
                function getRsBlockTable(typeNumber, errorCorrectionLevel){
                    switch(errorCorrectionLevel){
                        case QRErrorCorrectionLevel.L: return RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 0]
                        case QRErrorCorrectionLevel.M: return RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 1]
                        case QRErrorCorrectionLevel.Q: return RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 2]
                        case QRErrorCorrectionLevel.H: return RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 3]
                        default: return undefined
                    }
                }
                return {
                    getRSBlocks: function(typeNumber, errorCorrectionLevel){
                        var rsBlock = getRsBlockTable(typeNumber, errorCorrectionLevel)
                        if (typeof rsBlock == 'undefined') throw new Error('bad rs block @ typeNumber:' + typeNumber + '/errorCorrectionLevel:' + errorCorrectionLevel)
                        var length = rsBlock.length / 3
                        var list = []
                        for (var i=0; i<length; i++){
                            var count = rsBlock[i*3+0]
                            var totalCount = rsBlock[i*3+1]
                            var dataCount = rsBlock[i*3+2]
                            for (var j=0; j<count; j++) list.push(new QRRSBlock(totalCount, dataCount))
                        }
                        return list
                    }
                }
            })()

            document.addEventListener('click', function(ev){
                var btn = ev.target.closest('.tab')
                if (btn){
                    switchTab(btn.dataset.tab)
                    return
                }
            })

            el('sendBtn').addEventListener('click', sendMessage)
            el('chatInput').addEventListener('keydown', function(e){
                if (e.key === 'Enter') sendMessage()
            })
            el('modelSelect').addEventListener('change', changeModel)
            el('clearLogsBtn').addEventListener('click', function(){ el('logsPre').textContent = '' })
            el('reloadConfigBtn').addEventListener('click', loadConfig)
            el('addConfigBtn').addEventListener('click', addConfig)
            el('copyUrlBtn').addEventListener('click', copyAccessUrl)
            el('saveUrlBtn').addEventListener('click', saveAccessUrl)
            el('refreshLanBtn').addEventListener('click', loadLanHosts)
            el('useLanBtn').addEventListener('click', useLanSelected)
            el('accessUrlInput').addEventListener('input', function(){
                setAccessUrl(el('accessUrlInput').value)
            })

            setOnline(false)
            setChatConn(false)
            setModelInfo('')
            initAccessPanel()
            initAccessUrl()
            loadModels()
            loadConfig()
            connectLogWS()
            connectChatWS()
        })();
    </script>
</body>
</html>
